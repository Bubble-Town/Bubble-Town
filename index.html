<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bubble Town</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; overflow: hidden; touch-action: none; }
        
        /* Auth Screen */
        #authScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .authBox {
            background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .authBox h1 { text-align: center; color: #667eea; margin-bottom: 20px; }
        .inputGroup { margin-bottom: 15px; }
        .inputGroup label { display: block; margin-bottom: 5px; font-weight: bold; }
        .inputGroup input {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;
        }
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px;
            font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btnPrimary { background: #667eea; color: white; }
        .btnGoogle { background: #4285f4; color: white; }
        .authToggle { text-align: center; margin-top: 15px; color: #666; }
        .authToggle a { color: #667eea; cursor: pointer; text-decoration: underline; }
        .errorMsg { color: #e74c3c; text-align: center; margin-bottom: 10px; min-height: 20px; }
        
        /* Game Screen */
        #gameScreen { display: none; width: 100vw; height: 100vh; position: relative; }
        
        /* World */
        #worldContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #90EE90 50%, #228B22 100%);
            overflow: hidden;
        }
        #world {
            position: absolute; top: 50%; left: 50%; width: 2000px; height: 2000px;
            transform: translate(-50%, -50%);
        }
        
        /* Avatar */
        .avatar {
            position: absolute; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            transition: all 0.1s; z-index: 100; border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .avatarName {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 10px;
            font-size: 12px; white-space: nowrap;
        }
        
        /* Aquarium Building */
        .aquariumBuilding {
            position: absolute; width: 80px; height: 80px; left: 500px; top: 500px;
            background: linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%);
            border-radius: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 50;
        }
        .aquariumBuilding::after { content: 'üê†'; }
        
        /* Chat */
        #chatContainer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
        }
        #chatMessages {
            flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; color: white;
        }
        .chatMsg { margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; }
        .chatMsg .user { color: #667eea; font-weight: bold; }
        #chatInputArea { display: flex; padding: 10px; gap: 10px; }
        #chatInput {
            flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 16px;
        }
        #chatSend { padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; }
        
        /* Mobile Controls */
        #mobileControls {
            display: none; position: absolute; bottom: 160px; left: 20px; z-index: 200;
        }
        .dPad {
            width: 120px; height: 120px; position: relative;
        }
        .dPadBtn {
            position: absolute; width: 40px; height: 40px; background: rgba(255,255,255,0.8);
            border: none; border-radius: 8px; font-size: 20px; display: flex;
            align-items: center; justify-content: center;
        }
        .dPadUp { top: 0; left: 40px; }
        .dPadDown { bottom: 0; left: 40px; }
        .dPadLeft { top: 40px; left: 0; }
        .dPadRight { top: 40px; right: 0; }
        
        /* Aquarium Modal */
        #aquariumModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #001f3f 0%, #003366 100%); z-index: 500;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .aquariumTimer {
            position: absolute; top: 20px; right: 20px; color: white; font-size: 24px;
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px;
        }
        .fish { position: absolute; font-size: 50px; animation: swim 8s linear infinite; }
        @keyframes swim { 0% { transform: translateX(-100px); } 100% { transform: translateX(calc(100vw + 100px)); } }
        .closeAquarium {
            position: absolute; top: 20px; left: 20px; padding: 12px 24px;
            background: #e74c3c; color: white; border: none; border-radius: 8px;
            font-size: 16px; cursor: pointer;
        }
        
        /* Sidebar */
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 200px;
            background: rgba(0,0,0,0.8); border-radius: 10px; padding: 15px; color: white;
        }
        #sidebar h3 { margin-bottom: 10px; color: #667eea; font-size: 14px; }
        .sidebarItem { padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; margin-bottom: 8px; font-size: 13px; }
        
        /* Toast */
        #toastContainer {
            position: fixed; top: 80px; right: 10px; z-index: 2500;
        }
        .toast {
            background: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .authBox { padding: 20px; }
            #chatContainer { height: 120px; }
            #mobileControls { display: block; }
            #sidebar { width: 150px; font-size: 12px; }
            .aquariumTimer { font-size: 18px; padding: 10px; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="authBox">
            <h1>ü´ß Bubble Town</h1>
            <div class="errorMsg" id="errorMsg"></div>
            
            <div id="loginForm">
                <div class="inputGroup">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="inputGroup">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Password">
                </div>
                <button class="btn btnPrimary" onclick="login()">Sign In</button>
                <button class="btn btnGoogle" onclick="googleLogin()">Sign in with Google</button>
                <div class="authToggle">
                    Don't have an account? <a onclick="showRegister()">Register</a>
                </div>
            </div>
            
            <div id="registerForm" style="display:none;">
                <div class="inputGroup">
                    <label>Name</label>
                    <input type="text" id="regName" placeholder="Your name" maxlength="15">
                </div>
                <div class="inputGroup">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="your@email.com">
                </div>
                <div class="inputGroup">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="Min 6 characters">
                </div>
                <div class="inputGroup">
                    <label>Birth Date</label>
                    <input type="date" id="regBirthdate">
                </div>
                <div class="inputGroup">
                    <label><input type="checkbox" id="ageConfirm"> I am 13+ years old</label>
                </div>
                <button class="btn btnPrimary" onclick="register()">Create Account</button>
                <div class="authToggle">
                    Have an account? <a onclick="showLogin()">Login</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen">
        <div id="worldContainer">
            <div id="world">
                <div class="aquariumBuilding" onclick="openAquarium()"></div>
            </div>
        </div>
        
        <!-- Mobile Controls -->
        <div id="mobileControls">
            <div class="dPad">
                <button class="dPadBtn dPadUp" ontouchstart="move('up')" onmousedown="move('up')">‚¨ÜÔ∏è</button>
                <button class="dPadBtn dPadDown" ontouchstart="move('down')" onmousedown="move('down')">‚¨áÔ∏è</button>
                <button class="dPadBtn dPadLeft" ontouchstart="move('left')" onmousedown="move('left')">‚¨ÖÔ∏è</button>
                <button class="dPadBtn dPadRight" ontouchstart="move('right')" onmousedown="move('right')">‚û°Ô∏è</button>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div id="sidebar">
            <h3>üë§ <span id="playerName">Player</span></h3>
            <div class="sidebarItem">üê† Clownfish: <span id="hasClownfish">‚ùå</span></div>
            <div class="sidebarItem">üê¨ Dolphin: <span id="hasDolphin">‚ùå</span></div>
            <h3>üéÆ Online</h3>
            <div id="onlineList"></div>
        </div>
        
        <!-- Chat -->
        <div id="chatContainer">
            <div id="chatMessages"></div>
            <div id="chatInputArea">
                <input type="text" id="chatInput" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendChat()">
                <button id="chatSend" onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Aquarium Modal -->
    <div id="aquariumModal">
        <button class="closeAquarium" onclick="closeAquarium()">‚úï Leave</button>
        <div class="aquariumTimer" id="aquariumTimer">00:00:00</div>
        <div class="fish" style="top:20%; animation-delay:0s;">üê†</div>
        <div class="fish" style="top:40%; animation-delay:2s;">üêü</div>
        <div class="fish" style="top:60%; animation-delay:4s;">üê°</div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyABei0Z3yZ3xV741mW3ekV2ibFEf9QlCjc",
            authDomain: "bubble-town-25f24.firebaseapp.com",
            databaseURL: "https://bubble-town-25f24-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bubble-town-25f24",
            storageBucket: "bubble-town-25f24.firebasestorage.app",
            messagingSenderId: "885824915709",
            appId: "1:885824915709:web:fd25195326cfd31577d694"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        // Game State
        let user = null;
        let userData = {};
        let playerPos = { x: 1000, y: 1000 };
        let avatar = null;
        let aquariumTime = 0;
        let aquariumInterval = null;
        let keys = {};
        
        // Auth Functions
        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
        }
        
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            showError('');
        }
        
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            showError('');
        }
        
        function calculateAge(birthdate) {
            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }
        
        function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const birthdate = document.getElementById('regBirthdate').value;
            const ageConfirm = document.getElementById('ageConfirm').checked;
            
            if (!name || !email || !password || !birthdate) {
                showError('Please fill all fields');
                return;
            }
            if (password.length < 6) {
                showError('Password must be 6+ characters');
                return;
            }
            if (!ageConfirm) {
                showError('You must confirm you are 13+');
                return;
            }
            
            const age = calculateAge(birthdate);
            if (age < 13) {
                showError('You must be at least 13 years old');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((cred) => {
                    const isAdmin = email === 'a.hannaway.contact@gmail.com';
                    return db.ref('users/' + cred.user.uid).set({
                        name: name,
                        email: email,
                        age: age,
                        isAdult: age >= 18,
                        isAdmin: isAdmin,
                        clownfish: isAdmin,
                        dolphin: isAdmin,
                        x: 1000,
                        y: 1000,
                        online: true
                    });
                })
                .then(() => showToast('Account created!'))
                .catch(err => showError(err.message));
        }
        
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => showError(err.message));
        }
        
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(err => showError(err.message));
        }
        
        // Game Functions
        function startGame() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            // Create avatar
            avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.style.background = '#ff6b6b';
            avatar.innerHTML = 'üòä<div class="avatarName">' + userData.name + '</div>';
            document.getElementById('world').appendChild(avatar);
            updateAvatarPos();
            
            // Update sidebar
            document.getElementById('playerName').textContent = userData.name;
            document.getElementById('hasClownfish').textContent = userData.clownfish ? '‚úÖ' : '‚ùå';
            document.getElementById('hasDolphin').textContent = userData.dolphin ? '‚úÖ' : '‚ùå';
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                handleMovement();
            });
            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });
            
            // Save position to database
            setInterval(() => {
                if (user) {
                    db.ref('users/' + user.uid).update({ x: playerPos.x, y: playerPos.y });
                }
            }, 1000);
            
            // Listen for other players
            db.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                let onlineHtml = '';
                for (const uid in users) {
                    if (uid !== user.uid && users[uid].online) {
                        onlineHtml += '<div class="sidebarItem">' + users[uid].name + '</div>';
                    }
                }
                document.getElementById('onlineList').innerHTML = onlineHtml || '<div class="sidebarItem">No one else online</div>';
            });
        }
        
        function handleMovement() {
            const speed = 5;
            if (keys['w'] || keys['arrowup']) playerPos.y -= speed;
            if (keys['s'] || keys['arrowdown']) playerPos.y += speed;
            if (keys['a'] || keys['arrowleft']) playerPos.x -= speed;
            if (keys['d'] || keys['arrowright']) playerPos.x += speed;
            
            // Bounds
            playerPos.x = Math.max(0, Math.min(2000, playerPos.x));
            playerPos.y = Math.max(0, Math.min(2000, playerPos.y));
            
            updateAvatarPos();
        }
        
        function move(direction) {
            const speed = 20;
            if (direction === 'up') playerPos.y -= speed;
            if (direction === 'down') playerPos.y += speed;
            if (direction === 'left') playerPos.x -= speed;
            if (direction === 'right') playerPos.x += speed;
            
            playerPos.x = Math.max(0, Math.min(2000, playerPos.x));
            playerPos.y = Math.max(0, Math.min(2000, playerPos.y));
            updateAvatarPos();
        }
        
        function updateAvatarPos() {
            if (avatar) {
                avatar.style.left = playerPos.x + 'px';
                avatar.style.top = playerPos.y + 'px';
            }
        }
        
        // Chat
        function sendChat() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            if (!userData.isAdult) {
                showToast('Chat is 18+ only');
                return;
            }
            
            // Check for links
            if (text.includes('http') || text.includes('www')) {
                showToast('Links not allowed');
                return;
            }
            
            // Profanity filter
            const badWords = ['fuck', 'shit', 'damn', 'bitch', 'ass'];
            let filtered = text;
            badWords.forEach(word => {
                filtered = filtered.replace(new RegExp(word, 'gi'), '***');
            });
            
            const msg = document.createElement('div');
            msg.className = 'chatMsg';
            msg.innerHTML = '<span class="user">' + userData.name + ':</span> ' + filtered;
            document.getElementById('chatMessages').appendChild(msg);
            document.getElementById('chatMessages').scrollTop = 999999;
            
            // Save to database
            db.ref('chat').push({
                name: userData.name,
                text: filtered,
                time: Date.now()
            });
            
            input.value = '';
        }
        
        // Load chat history
        db.ref('chat').limitToLast(50).on('child_added', (snapshot) => {
            const msg = snapshot.val();
            const div = document.createElement('div');
            div.className = 'chatMsg';
            div.innerHTML = '<span class="user">' + msg.name + ':</span> ' + msg.text;
            const container = document.getElementById('chatMessages');
            if (container) {
                container.appendChild(div);
                container.scrollTop = 999999;
            }
        });
        
        // Aquarium
        function openAquarium() {
            document.getElementById('aquariumModal').style.display = 'flex';
            aquariumTime = 0;
            aquariumInterval = setInterval(() => {
                aquariumTime++;
                const hrs = Math.floor(aquariumTime / 3600);
                const mins = Math.floor((aquariumTime % 3600) / 60);
                const secs = aquariumTime % 60;
                document.getElementById('aquariumTimer').textContent = 
                    String(hrs).padStart(2,'0') + ':' + String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
                
                // Check rewards
                if (aquariumTime >= 3600 && !userData.clownfish) {
                    userData.clownfish = true;
                    db.ref('users/' + user.uid).update({ clownfish: true });
                    showToast('üê† You got a Clownfish!');
                    document.getElementById('hasClownfish').textContent = '‚úÖ';
                }
                if (aquariumTime >= 21600 && !userData.dolphin) {
                    userData.dolphin = true;
                    db.ref('users/' + user.uid).update({ dolphin: true });
                    showToast('üê¨ You got a Dolphin!');
                    document.getElementById('hasDolphin').textContent = '‚úÖ';
                }
            }, 1000);
        }
        
        function closeAquarium() {
            document.getElementById('aquariumModal').style.display = 'none';
            clearInterval(aquariumInterval);
        }
        
        // Auth State
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                db.ref('users/' + u.uid).once('value').then((snap) => {
                    userData = snap.val() || {};
                    if (!userData.name) userData.name = u.displayName || 'Player';
                    db.ref('users/' + u.uid).update({ online: true });
                    startGame();
                });
            }
        });
        
        // Set offline on disconnect
        window.onbeforeunload = () => {
            if (user) {
                db.ref('users/' + user.uid).update({ online: false });
            }
        };
    </script>
</body>
</html>